@using TimeTrackerApp.Models.ViewModels
@using TimeTrackerApp.Models
@model WeeklyTimeGridViewModel

@{
    ViewData["Title"] = "Kalendarz Tygodniowy";
}

<div class="timegrid-container">
    <div class="timegrid-header">
        <div class="timegrid-nav">
            <a asp-action="Index" asp-route-date="@Model.PrevWeek.ToString("yyyy-MM-dd")" asp-route-employeeId="@Model.EmployeeId" class="btn-calendar-nav">&laquo;</a>
            <div class="timegrid-title">
                <h2>@Model.WeekStart.ToString("d MMM") ‚Äì @Model.WeekEnd.ToString("d MMM yyyy")</h2>
                <div class="muted">
                    @if (Model.CanSelectEmployee && Model.AllEmployees != null)
                    {
                        <span>Pracownik: </span>
                        <select id="employeeSelect" class="employee-select" onchange="changeEmployee(this.value)">
                            @foreach (var emp in Model.AllEmployees)
                            {
                                <option value="@emp.Id" selected="@(emp.Id == Model.EmployeeId)">@emp.User.FirstName @emp.User.LastName</option>
                            }
                        </select>
                    }
                    else
                    {
                        <span>Pracownik: <strong>@Model.EmployeeName</strong></span>
                    }
                </div>
            </div>
            <a asp-action="Index" asp-route-date="@Model.NextWeek.ToString("yyyy-MM-dd")" asp-route-employeeId="@Model.EmployeeId" class="btn-calendar-nav">&raquo;</a>
        </div>
        <div class="timegrid-actions">
            <a asp-controller="TimeEntries" asp-action="Index" class="btn btn-secondary">Lista wpis√≥w</a>
        </div>
    </div>

    <div class="timegrid-wrapper">
        <div class="timegrid">
            <!-- Time column -->
            <div class="timegrid-time-col">
                <div class="timegrid-time-header"></div>
                @for (int hour = 0; hour < 24; hour++)
                {
                    <div class="timegrid-time-cell">
                        <span>@hour.ToString("00"):00</span>
                    </div>
                }
            </div>

            <!-- Day columns -->
            @foreach (var day in Model.DaysOfWeek)
            {
                var isToday = day.Date == DateTime.Today;
                var dayEntries = Model.EntriesByDay.ContainsKey(day) ? Model.EntriesByDay[day] : new List<TimeGridEntry>();
                var dayMarker = Model.DayMarkers.ContainsKey(day) ? Model.DayMarkers[day] : null;
                var dayTypeClass = dayMarker != null ? GetDayTypeClass(dayMarker.Type) : "";

                <div class="timegrid-day-col @(isToday ? "today" : "") @dayTypeClass" data-date="@day.ToString("yyyy-MM-dd")">
                    <div class="timegrid-day-header">
                        <div style="flex: 1;">
                            <div class="day-name">@day.ToString("ddd", new System.Globalization.CultureInfo("pl-PL"))</div>
                            <div class="day-date">@day.ToString("d MMM")</div>
                        </div>
                        <div class="day-marker-selector">
                            <button class="btn-day-marker" onclick="toggleDayMarkerMenu(event, '@day.ToString("yyyy-MM-dd")')">
                                @if (dayMarker != null)
                                {
                                    <span>@GetDayTypeIcon(dayMarker.Type)</span>
                                }
                                else
                                {
                                    <span>‚Ä¢‚Ä¢‚Ä¢</span>
                                }
                            </button>
                            <div class="day-marker-menu" id="menu-@day.ToString("yyyy-MM-dd")" style="display: none;">
                                <div class="day-marker-option" onclick="setDayMarker('@day.ToString("yyyy-MM-dd")', 1)">
                                    <span class="marker-icon" style="background: rgba(147, 51, 234, 0.2);"></span>
                                    <span>Delegacja</span>
                                    @if (dayMarker?.Type == DayType.BusinessTrip) { <span>‚úì</span> }
                                </div>
                                <div class="day-marker-option" onclick="setDayMarker('@day.ToString("yyyy-MM-dd")', 2)">
                                    <span class="marker-icon" style="background: rgba(156, 163, 175, 0.3);"></span>
                                    <span>Dzie≈Ñ wolny</span>
                                    @if (dayMarker?.Type == DayType.DayOff) { <span>‚úì</span> }
                                </div>
                                <div class="day-marker-option" onclick="setDayMarker('@day.ToString("yyyy-MM-dd")', 3)">
                                    <span class="marker-icon" style="background: rgba(234, 179, 8, 0.2);"></span>
                                    <span>Choroba</span>
                                    @if (dayMarker?.Type == DayType.Sick) { <span>‚úì</span> }
                                </div>
                                <div class="day-marker-option" onclick="setDayMarker('@day.ToString("yyyy-MM-dd")', 4)">
                                    <span class="marker-icon" style="background: rgba(244, 114, 182, 0.2);"></span>
                                    <span>Urlop</span>
                                    @if (dayMarker?.Type == DayType.Vacation) { <span>‚úì</span> }
                                </div>
                                @if (dayMarker != null)
                                {
                                    <div class="day-marker-option" onclick="removeDayMarker('@day.ToString("yyyy-MM-dd")')" style="color: var(--danger); border-top: 1px solid var(--border);">
                                        <span>√ó</span>
                                        <span>Usu≈Ñ oznaczenie</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Hour cells -->
                    <div class="timegrid-day-cells" data-day="@day.ToString("yyyy-MM-dd")">
                        @for (int hour = 0; hour < 24; hour++)
                        {
                            <div class="timegrid-hour-cell" data-hour="@hour"></div>
                        }

                        <!-- Render existing entries -->
                        @foreach (var entry in dayEntries)
                        {
                            var startHour = entry.StartTime.TotalHours;
                            var duration = (entry.EndTime - entry.StartTime).TotalHours;
                            var top = startHour * 60; // 60px per hour
                            var height = duration * 60;

                            <div class="timegrid-entry"
                                 style="top: @(top)px; height: @(height)px;"
                                 data-entry-id="@entry.Id"
                                 data-entry-date="@day.ToString("yyyy-MM-dd")"
                                 data-start="@entry.StartTime.ToString()"
                                 data-end="@entry.EndTime.ToString()"
                                 data-project-id="@entry.ProjectId"
                                 data-original-top="@(top)"
                                 data-original-height="@(height)">
                                <div class="entry-time">@entry.StartTime.ToString(@"hh\:mm") ‚Äì @entry.EndTime.ToString(@"hh\:mm")</div>
                                <div class="entry-project">@(entry.ProjectName ?? "(brak projektu)")</div>
                                @if (!string.IsNullOrEmpty(entry.Description))
                                {
                                    <div class="entry-desc">@entry.Description</div>
                                }
                                <div class="entry-created-by">‚úçÔ∏è @entry.CreatedBy</div>
                                <button class="entry-edit" onclick="editEntry(@entry.Id); event.stopPropagation();">‚úé</button>
                                <button class="entry-delete" onclick="deleteEntry(@entry.Id); event.stopPropagation();">√ó</button>
                                <div class="resize-handle resize-handle-top" data-direction="top"></div>
                                <div class="resize-handle resize-handle-bottom" data-direction="bottom"></div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="timegrid-legend">
        <div class="hint">
            <strong>Wskaz√≥wki:</strong> 
            <span>PrzeciƒÖgnij wpis, aby przenie≈õƒá (z live preview + zmiana dnia!). </span>
            <span>U≈ºyj uchwyt√≥w g√≥ra/d√≥≈Ç, aby zmieniƒá czas trwania. </span>
            <span>Kliknij pustƒÖ przestrze≈Ñ, aby dodaƒá nowy wpis.</span>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="display: inline-block; width: 16px; height: 16px; background: rgba(147, 51, 234, 0.2); border-radius: 3px;"></span>
                <span style="font-size: 0.875rem;">Delegacja</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="display: inline-block; width: 16px; height: 16px; background: rgba(156, 163, 175, 0.3); border-radius: 3px;"></span>
                <span style="font-size: 0.875rem;">Dzie≈Ñ wolny</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="display: inline-block; width: 16px; height: 16px; background: rgba(234, 179, 8, 0.2); border-radius: 3px;"></span>
                <span style="font-size: 0.875rem;">Choroba</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.25rem;">
                <span style="display: inline-block; width: 16px; height: 16px; background: rgba(244, 114, 182, 0.2); border-radius: 3px;"></span>
                <span style="font-size: 0.875rem;">Urlop</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding/editing entry -->
<div id="entryModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Nowy wpis czasu</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="entryId" value="" />
            <input type="hidden" id="entryDate" value="" />

            <div class="form-group">
                <label>Czas</label>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 0.75rem; align-items: center;">
                    <div>
                        <label style="font-size: 0.875rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Od</label>
                        <input type="time" id="entryStartTime" class="form-control" step="900" required />
                    </div>
                    <span style="margin-top: 1.5rem; color: var(--text-tertiary);">‚Äî</span>
                    <div>
                        <label style="font-size: 0.875rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Do</label>
                        <input type="time" id="entryEndTime" class="form-control" step="900" required />
                    </div>
                </div>
                <div id="durationDisplay" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"></div>
            </div>

            <div class="form-group">
                <label for="projectSelect">Projekt</label>
                <select id="projectSelect" class="form-control">
                    <option value="">(brak)</option>
                    @foreach (var project in Model.Projects)
                    {
                        <option value="@project.Id">@project.Name</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="descriptionInput">Opis</label>
                <textarea id="descriptionInput" class="form-control" rows="3" placeholder="Opisz wykonywnƒÖ pracƒô..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
            <button class="btn btn-primary" onclick="saveEntry()">Zapisz</button>
        </div>
    </div>
</div>

<!-- Drag Preview Element -->
<div id="dragPreview" class="drag-preview" style="display: none;"></div>

@functions {
    string GetDayTypeClass(DayType type)
    {
        return type switch
        {
            DayType.BusinessTrip => "day-business-trip",
            DayType.DayOff => "day-off",
            DayType.Sick => "day-sick",
            DayType.Vacation => "day-vacation",
            _ => ""
        };
    }

    string GetDayTypeIcon(DayType type)
    {
        return type switch
        {
            DayType.BusinessTrip => "üíº",
            DayType.DayOff => "üìã",
            DayType.Sick => "ü©∫",
            DayType.Vacation => "üèñÔ∏è",
            _ => ""
        };
    }
}

<script>
const employeeId = @Model.EmployeeId;
let isSelecting = false;
let selectionStart = null;
let selectionEnd = null;
let currentDayCol = null;

// Drag & Drop state
let isDragging = false;
let isResizing = false;
let draggedEntry = null;
let dragPreviewEl = null;
let resizeDirection = null;
let dragStartY = 0;
let dragStartX = 0;
let entryOriginalTop = 0;
let entryOriginalHeight = 0;
let currentTargetDay = null;
let currentTargetDate = null;
const PIXELS_PER_HOUR = 60;
const SNAP_MINUTES = 15;

function changeEmployee(newEmployeeId) {
    const currentDate = '@Model.WeekStart.ToString("yyyy-MM-dd")';
    window.location.href = `@Url.Action("Index", "Calendar")?date=${currentDate}&employeeId=${newEmployeeId}`;
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.day-marker-selector')) {
        document.querySelectorAll('.day-marker-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

function toggleDayMarkerMenu(event, date) {
    event.stopPropagation();
    const menu = document.getElementById(`menu-${date}`);
    const allMenus = document.querySelectorAll('.day-marker-menu');
    allMenus.forEach(m => {
        if (m !== menu) m.style.display = 'none';
    });
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

async function setDayMarker(date, type) {
    const response = await fetch('@Url.Action("SetDayMarker", "Calendar")', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ employeeId: employeeId, date: date, type: type, note: null })
    });
    const result = await response.json();
    if (result.success) location.reload();
    else alert(result.message || 'B≈ÇƒÖd ustawiania oznaczenia');
}

async function removeDayMarker(date) {
    const response = await fetch('@Url.Action("RemoveDayMarker", "Calendar")', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ employeeId: employeeId, date: date })
    });
    const result = await response.json();
    if (result.success) location.reload();
    else alert(result.message || 'B≈ÇƒÖd usuwania oznaczenia');
}

function updateDurationDisplay() {
    const startInput = document.getElementById('entryStartTime');
    const endInput = document.getElementById('entryEndTime');
    const durationDiv = document.getElementById('durationDisplay');
    
    if (!startInput.value || !endInput.value) {
        durationDiv.textContent = '';
        return;
    }
    
    const [startH, startM] = startInput.value.split(':').map(Number);
    const [endH, endM] = endInput.value.split(':').map(Number);
    const startMinutes = startH * 60 + startM;
    const endMinutes = endH * 60 + endM;
    const durationMinutes = endMinutes - startMinutes;
    
    if (durationMinutes <= 0) {
        durationDiv.textContent = '‚ö†Ô∏è Czas zako≈Ñczenia musi byƒá p√≥≈∫niejszy ni≈º czas rozpoczƒôcia';
        durationDiv.style.color = 'var(--danger)';
        return;
    }
    
    const hours = Math.floor(durationMinutes / 60);
    const minutes = durationMinutes % 60;
    let durationText = 'Czas trwania: ';
    if (hours > 0) durationText += `${hours}h `;
    if (minutes > 0) durationText += `${minutes}min`;
    durationDiv.textContent = durationText;
    durationDiv.style.color = 'var(--text-secondary)';
}

function pixelsToTime(pixels, snap = true) {
    let totalMinutes = Math.round((pixels / PIXELS_PER_HOUR) * 60);
    if (snap) {
        totalMinutes = Math.round(totalMinutes / SNAP_MINUTES) * SNAP_MINUTES;
    }
    totalMinutes = Math.max(0, Math.min(totalMinutes, 24 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return { hours, minutes, totalMinutes };
}

function timeToPixels(hours, minutes) {
    return ((hours * 60 + minutes) / 60) * PIXELS_PER_HOUR;
}

function formatTimeSpan(hours, minutes) {
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:00`;
}

function formatTimeDisplay(hours, minutes) {
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const days = ['Nd', 'Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So'];
    const months = ['sty', 'lut', 'mar', 'kwi', 'maj', 'cze', 'lip', 'sie', 'wrz', 'pa≈∫', 'lis', 'gru'];
    return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
}

// ====================
// DRAG & DROP: Moving entries with LIVE PREVIEW + MULTI-DAY SUPPORT
// ====================

document.querySelectorAll('.timegrid-entry').forEach(entry => {
    entry.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('entry-edit') || 
            e.target.classList.contains('entry-delete') ||
            e.target.classList.contains('resize-handle')) {
            return;
        }
        
        e.preventDefault();
        isDragging = true;
        draggedEntry = entry;
        dragStartY = e.clientY;
        dragStartX = e.clientX;
        entryOriginalTop = parseFloat(entry.dataset.originalTop);
        entryOriginalHeight = parseFloat(entry.dataset.originalHeight);
        
        // Create preview element
        dragPreviewEl = document.getElementById('dragPreview');
        const entryRect = entry.getBoundingClientRect();
        dragPreviewEl.style.width = entryRect.width + 'px';
        dragPreviewEl.style.height = entryRect.height + 'px';
        dragPreviewEl.style.display = 'block';
        dragPreviewEl.innerHTML = entry.innerHTML;
        
        // Hide original
        entry.classList.add('dragging');
        
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
    });
});

function handleDragMove(e) {
    if (!isDragging || !draggedEntry || !dragPreviewEl) return;
    
    // Move preview element with cursor
    dragPreviewEl.style.left = (e.clientX - dragPreviewEl.offsetWidth / 2) + 'px';
    dragPreviewEl.style.top = (e.clientY - 20) + 'px';
    
    // Find target day column using pointer-events: none trick
    dragPreviewEl.style.pointerEvents = 'none';
    const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
    dragPreviewEl.style.pointerEvents = 'auto';
    
    const targetDayCell = elementBelow?.closest('.timegrid-day-cells');
    const targetDayCol = elementBelow?.closest('.timegrid-day-col');
    
    if (targetDayCell && targetDayCol) {
        currentTargetDay = targetDayCell;
        currentTargetDate = targetDayCol.dataset.date;
        
        const rect = targetDayCell.getBoundingClientRect();
        const offsetY = e.clientY - rect.top;
        
        // Calculate new time with snap
        const time = pixelsToTime(offsetY, true);
        
        // Calculate duration from original entry
        const oldStart = draggedEntry.dataset.start;
        const oldEnd = draggedEntry.dataset.end;
        const [oldStartH, oldStartM] = oldStart.split(':').map(Number);
        const [oldEndH, oldEndM] = oldEnd.split(':').map(Number);
        const durationMinutes = (oldEndH * 60 + oldEndM) - (oldStartH * 60 + oldStartM);
        
        // Calculate new end time
        const newEndMinutes = time.totalMinutes + durationMinutes;
        const newEndH = Math.floor(newEndMinutes / 60);
        const newEndM = newEndMinutes % 60;
        
        // Validate range
        if (time.hours >= 0 && time.hours < 24 && newEndH < 24) {
            const timeDisplay = formatTimeDisplay(time.hours, time.minutes) + ' ‚Äì ' + formatTimeDisplay(newEndH, newEndM);
            const dateDisplay = formatDate(currentTargetDate);
            
            const timeEl = dragPreviewEl.querySelector('.entry-time');
            if (timeEl) {
                // Check if date changed
                const originalDate = draggedEntry.dataset.entryDate;
                if (originalDate !== currentTargetDate) {
                    timeEl.textContent = `${dateDisplay} | ${timeDisplay}`;
                } else {
                    timeEl.textContent = timeDisplay;
                }
            }
        }
    }
}

async function handleDragEnd(e) {
    if (!isDragging || !draggedEntry) return;
    
    isDragging = false;
    document.removeEventListener('mousemove', handleDragMove);
    document.removeEventListener('mouseup', handleDragEnd);
    
    // Hide preview
    if (dragPreviewEl) {
        dragPreviewEl.style.display = 'none';
    }
    
    // Show original
    draggedEntry.classList.remove('dragging');
    
    if (!currentTargetDay || !currentTargetDate) {
        draggedEntry = null;
        currentTargetDay = null;
        currentTargetDate = null;
        return;
    }
    
    const rect = currentTargetDay.getBoundingClientRect();
    const offsetY = e.clientY - rect.top;
    const time = pixelsToTime(offsetY, true);
    const newStartMinutes = time.totalMinutes;
    
    // Calculate duration
    const oldStart = draggedEntry.dataset.start;
    const oldEnd = draggedEntry.dataset.end;
    const [oldStartH, oldStartM] = oldStart.split(':').map(Number);
    const [oldEndH, oldEndM] = oldEnd.split(':').map(Number);
    const durationMinutes = (oldEndH * 60 + oldEndM) - (oldStartH * 60 + oldStartM);
    
    // Calculate new end
    const newEndMinutes = newStartMinutes + durationMinutes;
    const newStartH = Math.floor(newStartMinutes / 60);
    const newStartM = newStartMinutes % 60;
    const newEndH = Math.floor(newEndMinutes / 60);
    const newEndM = newEndMinutes % 60;
    
    if (newStartH < 0 || newEndH >= 24) {
        alert('Wpis wykracza poza zakres 00:00 - 24:00');
        draggedEntry = null;
        currentTargetDay = null;
        currentTargetDate = null;
        return;
    }
    
    const entryId = draggedEntry.dataset.entryId;
    const originalDate = draggedEntry.dataset.entryDate;
    
    // Check if date changed - if so, need to delete and create new entry
    if (originalDate !== currentTargetDate) {
        // Delete old entry
        const deleteResponse = await fetch('@Url.Action("DeleteEntry", "Calendar")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: parseInt(entryId) })
        });
        
        const deleteResult = await deleteResponse.json();
        if (!deleteResult.success) {
            alert(deleteResult.message || 'B≈ÇƒÖd usuwania wpisu');
            draggedEntry = null;
            currentTargetDay = null;
            currentTargetDate = null;
            return;
        }
        
        // Create new entry on new date
        const createResponse = await fetch('@Url.Action("AddEntry", "Calendar")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                employeeId: employeeId,
                date: currentTargetDate,
                startTime: formatTimeSpan(newStartH, newStartM),
                endTime: formatTimeSpan(newEndH, newEndM),
                projectId: draggedEntry.dataset.projectId ? parseInt(draggedEntry.dataset.projectId) : null,
                description: draggedEntry.querySelector('.entry-desc')?.textContent || ''
            })
        });
        
        const createResult = await createResponse.json();
        if (createResult.success) {
            location.reload();
        } else {
            alert(createResult.message || 'B≈ÇƒÖd tworzenia wpisu');
        }
    } else {
        // Same day - just update time
        const response = await fetch('@Url.Action("UpdateEntry", "Calendar")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: parseInt(entryId),
                startTime: formatTimeSpan(newStartH, newStartM),
                endTime: formatTimeSpan(newEndH, newEndM),
                projectId: draggedEntry.dataset.projectId ? parseInt(draggedEntry.dataset.projectId) : null,
                description: draggedEntry.querySelector('.entry-desc')?.textContent || ''
            })
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.message || 'B≈ÇƒÖd przesuwania wpisu');
        }
    }
    
    draggedEntry = null;
    currentTargetDay = null;
    currentTargetDate = null;
}

// ====================
// RESIZE: Changing entry duration
// ====================

document.querySelectorAll('.resize-handle').forEach(handle => {
    handle.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        e.preventDefault();
        
        isResizing = true;
        draggedEntry = handle.closest('.timegrid-entry');
        resizeDirection = handle.dataset.direction;
        dragStartY = e.clientY;
        entryOriginalTop = parseFloat(draggedEntry.dataset.originalTop);
        entryOriginalHeight = parseFloat(draggedEntry.dataset.originalHeight);
        
        draggedEntry.classList.add('resizing');
        
        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', handleResizeEnd);
    });
});

function handleResize(e) {
    if (!isResizing || !draggedEntry) return;
    
    const deltaY = e.clientY - dragStartY;
    
    if (resizeDirection === 'top') {
        const newTop = entryOriginalTop + deltaY;
        const time = pixelsToTime(newTop, true);
        const snappedTop = timeToPixels(time.hours, time.minutes);
        const newHeight = entryOriginalHeight - (snappedTop - entryOriginalTop);
        
        if (snappedTop >= 0 && newHeight >= PIXELS_PER_HOUR / 4) {
            draggedEntry.style.top = snappedTop + 'px';
            draggedEntry.style.height = newHeight + 'px';
            
            const endTime = pixelsToTime(snappedTop + newHeight, true);
            draggedEntry.querySelector('.entry-time').textContent = 
                formatTimeDisplay(time.hours, time.minutes) + ' ‚Äì ' + formatTimeDisplay(endTime.hours, endTime.minutes);
        }
    } else if (resizeDirection === 'bottom') {
        const newHeight = entryOriginalHeight + deltaY;
        const time = pixelsToTime(newHeight, true);
        const snappedHeight = timeToPixels(time.hours, time.minutes);
        
        if (snappedHeight >= PIXELS_PER_HOUR / 4 && (entryOriginalTop + snappedHeight) <= 24 * PIXELS_PER_HOUR) {
            draggedEntry.style.height = snappedHeight + 'px';
            
            const startTime = pixelsToTime(entryOriginalTop, true);
            const endTime = pixelsToTime(entryOriginalTop + snappedHeight, true);
            draggedEntry.querySelector('.entry-time').textContent = 
                formatTimeDisplay(startTime.hours, startTime.minutes) + ' ‚Äì ' + formatTimeDisplay(endTime.hours, endTime.minutes);
        }
    }
}

async function handleResizeEnd(e) {
    if (!isResizing || !draggedEntry) return;
    
    isResizing = false;
    draggedEntry.classList.remove('resizing');
    
    document.removeEventListener('mousemove', handleResize);
    document.removeEventListener('mouseup', handleResizeEnd);
    
    const top = parseFloat(draggedEntry.style.top);
    const height = parseFloat(draggedEntry.style.height);
    
    const startTime = pixelsToTime(top, true);
    const endTime = pixelsToTime(top + height, true);
    
    if (startTime.totalMinutes >= endTime.totalMinutes) {
        alert('B≈Çƒôdny zakres czasu');
        location.reload();
        return;
    }
    
    const entryId = draggedEntry.dataset.entryId;
    const response = await fetch('@Url.Action("UpdateEntry", "Calendar")', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            id: parseInt(entryId),
            startTime: formatTimeSpan(startTime.hours, startTime.minutes),
            endTime: formatTimeSpan(endTime.hours, endTime.minutes),
            projectId: draggedEntry.dataset.projectId ? parseInt(draggedEntry.dataset.projectId) : null,
            description: draggedEntry.querySelector('.entry-desc')?.textContent || ''
        })
    });
    
    const result = await response.json();
    if (result.success) {
        location.reload();
    } else {
        alert(result.message || 'B≈ÇƒÖd zmiany rozmiaru wpisu');
        location.reload();
    }
}

// ====================
// SELECTION: Creating new entries
// ====================

document.querySelectorAll('.timegrid-day-col').forEach(dayCol => {
    const cells = dayCol.querySelector('.timegrid-day-cells');
    
    cells.addEventListener('mousedown', (e) => {
        if (e.target.closest('.timegrid-entry') || e.target.closest('.resize-handle')) {
            return;
        }
        
        if (e.target.classList.contains('timegrid-hour-cell') || e.target.classList.contains('timegrid-day-cells')) {
            isSelecting = true;
            currentDayCol = dayCol;
            
            const rect = cells.getBoundingClientRect();
            const offsetY = e.clientY - rect.top;
            const hour = Math.floor(offsetY / PIXELS_PER_HOUR);
            
            selectionStart = hour;
            selectionEnd = hour;
            updateSelection();
        }
    });
    
    cells.addEventListener('mousemove', (e) => {
        if (!isSelecting) return;
        
        const rect = cells.getBoundingClientRect();
        const offsetY = e.clientY - rect.top;
        const hour = Math.floor(offsetY / PIXELS_PER_HOUR);
        
        selectionEnd = hour;
        updateSelection();
    });
});

document.addEventListener('mouseup', () => {
    if (isSelecting) {
        isSelecting = false;
        if (selectionStart !== null && selectionEnd !== null) {
            openModalForNewEntry();
        }
    }
});

function updateSelection() {
    if (!currentDayCol) return;
    
    const cells = currentDayCol.querySelectorAll('.timegrid-hour-cell');
    cells.forEach((cell, index) => {
        const hour = parseInt(cell.dataset.hour);
        const min = Math.min(selectionStart, selectionEnd);
        const max = Math.max(selectionStart, selectionEnd);
        
        if (hour >= min && hour <= max) {
            cell.classList.add('selected');
        } else {
            cell.classList.remove('selected');
        }
    });
}

function clearSelection() {
    document.querySelectorAll('.timegrid-hour-cell').forEach(cell => {
        cell.classList.remove('selected');
    });
}

function openModalForNewEntry() {
    const min = Math.min(selectionStart, selectionEnd);
    const max = Math.max(selectionStart, selectionEnd) + 1;
    const date = currentDayCol.dataset.date;
    
    document.getElementById('modalTitle').textContent = 'Nowy wpis czasu';
    document.getElementById('entryId').value = '';
    document.getElementById('entryDate').value = date;
    document.getElementById('entryStartTime').value = `${min.toString().padStart(2, '0')}:00`;
    document.getElementById('entryEndTime').value = `${max.toString().padStart(2, '0')}:00`;
    document.getElementById('projectSelect').value = '';
    document.getElementById('descriptionInput').value = '';
    
    updateDurationDisplay();
    document.getElementById('entryStartTime').addEventListener('change', updateDurationDisplay);
    document.getElementById('entryEndTime').addEventListener('change', updateDurationDisplay);
    document.getElementById('entryModal').style.display = 'flex';
}

function editEntry(entryId) {
    const entryEl = document.querySelector(`[data-entry-id="${entryId}"]`);
    if (!entryEl) return;
    
    const dayCol = entryEl.closest('.timegrid-day-col');
    const date = dayCol.dataset.date;
    const startTime = entryEl.dataset.start;
    const endTime = entryEl.dataset.end;
    const projectId = entryEl.dataset.projectId || '';
    const description = entryEl.querySelector('.entry-desc')?.textContent || '';
    
    document.getElementById('modalTitle').textContent = 'Edytuj wpis';
    document.getElementById('entryId').value = entryId;
    document.getElementById('entryDate').value = date;
    document.getElementById('entryStartTime').value = startTime.substring(0, 5);
    document.getElementById('entryEndTime').value = endTime.substring(0, 5);
    document.getElementById('projectSelect').value = projectId;
    document.getElementById('descriptionInput').value = description;
    
    updateDurationDisplay();
    document.getElementById('entryStartTime').addEventListener('change', updateDurationDisplay);
    document.getElementById('entryEndTime').addEventListener('change', updateDurationDisplay);
    document.getElementById('entryModal').style.display = 'flex';
}

async function deleteEntry(entryId) {
    if (!confirm('Czy na pewno usunƒÖƒá ten wpis?')) return;
    
    const response = await fetch('@Url.Action("DeleteEntry", "Calendar")', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: entryId })
    });
    
    const result = await response.json();
    if (result.success) location.reload();
    else alert(result.message || 'B≈ÇƒÖd usuwania wpisu');
}

function closeModal() {
    document.getElementById('entryModal').style.display = 'none';
    clearSelection();
    selectionStart = null;
    selectionEnd = null;
    currentDayCol = null;
}

async function saveEntry() {
    const entryId = document.getElementById('entryId').value;
    const date = document.getElementById('entryDate').value;
    const startTime = document.getElementById('entryStartTime').value + ':00';
    const endTime = document.getElementById('entryEndTime').value + ':00';
    const projectId = document.getElementById('projectSelect').value || null;
    const description = document.getElementById('descriptionInput').value;
    
    const [startH, startM] = document.getElementById('entryStartTime').value.split(':').map(Number);
    const [endH, endM] = document.getElementById('entryEndTime').value.split(':').map(Number);
    const startMinutes = startH * 60 + startM;
    const endMinutes = endH * 60 + endM;
    
    if (endMinutes <= startMinutes) {
        alert('Czas zako≈Ñczenia musi byƒá p√≥≈∫niejszy ni≈º czas rozpoczƒôcia');
        return;
    }
    
    if (entryId) {
        const response = await fetch('@Url.Action("UpdateEntry", "Calendar")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: parseInt(entryId),
                startTime: startTime,
                endTime: endTime,
                projectId: projectId ? parseInt(projectId) : null,
                description: description
            })
        });
        
        const result = await response.json();
        if (result.success) location.reload();
        else alert(result.message || 'B≈ÇƒÖd aktualizacji wpisu');
    } else {
        const response = await fetch('@Url.Action("AddEntry", "Calendar")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                employeeId: employeeId,
                date: date,
                startTime: startTime,
                endTime: endTime,
                projectId: projectId ? parseInt(projectId) : null,
                description: description
            })
        });
        
        const result = await response.json();
        if (result.success) location.reload();
        else alert(result.message || 'B≈ÇƒÖd dodawania wpisu');
    }
}
</script>

@section Scripts {
    @Html.AntiForgeryToken()
}
